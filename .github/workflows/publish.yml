name: ğŸš€ å‘å¸ƒåˆ° NPM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” æ£€æµ‹å„åŒ…ç‰ˆæœ¬å˜åŒ–
        id: changes
        run: |
          check_version() {
            local name=$1
            local path=$2
            local old=$(git show HEAD^:$path 2>/dev/null | grep '"version"' | head -1 | sed 's/.*"\([^"]*\)".*/\1/' || echo "0.0.0")
            local new=$(grep '"version"' $path | head -1 | sed 's/.*"\([^"]*\)".*/\1/')
            echo "${name}_old=$old" >> $GITHUB_OUTPUT
            echo "${name}_new=$new" >> $GITHUB_OUTPUT
            if [ "$old" != "$new" ]; then
              echo "${name}=true" >> $GITHUB_OUTPUT
              echo "ğŸ“¦ $name: $old â†’ $new"
              return 0
            else
              echo "${name}=false" >> $GITHUB_OUTPUT
              return 1
            fi
          }

          ANY_CHANGED=false

          check_version "core" "packages/core/package.json" && ANY_CHANGED=true
          check_version "math" "packages/plugin-math/package.json" && ANY_CHANGED=true
          check_version "filesystem" "packages/plugin-filesystem/package.json" && ANY_CHANGED=true
          check_version "http" "packages/plugin-http/package.json" && ANY_CHANGED=true
          check_version "memory" "packages/plugin-memory/package.json" && ANY_CHANGED=true

          echo "any_changed=$ANY_CHANGED" >> $GITHUB_OUTPUT

          if [ "$ANY_CHANGED" = "false" ]; then
            echo "â­ï¸ æ²¡æœ‰åŒ…ç‰ˆæœ¬å˜åŒ–"
          fi

      - name: âš™ï¸ è®¾ç½® pnpm
        if: steps.changes.outputs.any_changed == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: âš™ï¸ è®¾ç½® Node.js
        if: steps.changes.outputs.any_changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"
          scope: "@mcp-decorator"
          cache: "pnpm"

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        if: steps.changes.outputs.any_changed == 'true'
        run: pnpm install --no-frozen-lockfile

      - name: ğŸ”¨ æ„å»ºæ‰€æœ‰åŒ…
        if: steps.changes.outputs.any_changed == 'true'
        run: pnpm run build

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        if: steps.changes.outputs.any_changed == 'true'
        run: pnpm test

      - name: ğŸš€ å‘å¸ƒ Core åŒ…
        if: steps.changes.outputs.core == 'true'
        run: |
          cd packages/core
          pnpm publish --access public --no-git-checks
          echo "âœ… @mcp-decorator/core@${{ steps.changes.outputs.core_new }} å‘å¸ƒæˆåŠŸ"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: â³ ç­‰å¾… NPM ç´¢å¼•æ›´æ–°
        if: steps.changes.outputs.core == 'true'
        run: |
          echo "ç­‰å¾… NPM ç´¢å¼•æ›´æ–°..."
          sleep 60

      - name: ğŸš€ å‘å¸ƒ Math æ’ä»¶
        if: steps.changes.outputs.math == 'true'
        run: |
          cd packages/plugin-math
          pnpm publish --access public --no-git-checks
          echo "âœ… @mcp-decorator/plugin-math@${{ steps.changes.outputs.math_new }} å‘å¸ƒæˆåŠŸ"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸš€ å‘å¸ƒ Filesystem æ’ä»¶
        if: steps.changes.outputs.filesystem == 'true'
        run: |
          cd packages/plugin-filesystem
          pnpm publish --access public --no-git-checks
          echo "âœ… @mcp-decorator/plugin-filesystem@${{ steps.changes.outputs.filesystem_new }} å‘å¸ƒæˆåŠŸ"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸš€ å‘å¸ƒ HTTP æ’ä»¶
        if: steps.changes.outputs.http == 'true'
        run: |
          cd packages/plugin-http
          pnpm publish --access public --no-git-checks
          echo "âœ… @mcp-decorator/plugin-http@${{ steps.changes.outputs.http_new }} å‘å¸ƒæˆåŠŸ"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸš€ å‘å¸ƒ Memory æ’ä»¶
        if: steps.changes.outputs.memory == 'true'
        run: |
          cd packages/plugin-memory
          pnpm publish --access public --no-git-checks
          echo "âœ… @mcp-decorator/plugin-memory@${{ steps.changes.outputs.memory_new }} å‘å¸ƒæˆåŠŸ"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ğŸ·ï¸ åˆ›å»º Git æ ‡ç­¾
        if: steps.changes.outputs.any_changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ä¸ºæ¯ä¸ªå˜åŒ–çš„åŒ…åˆ›å»ºæ ‡ç­¾
          if [ "${{ steps.changes.outputs.core }}" = "true" ]; then
            git tag -a "core@${{ steps.changes.outputs.core_new }}" -m "Release @mcp-decorator/core@${{ steps.changes.outputs.core_new }}" || true
          fi
          if [ "${{ steps.changes.outputs.math }}" = "true" ]; then
            git tag -a "plugin-math@${{ steps.changes.outputs.math_new }}" -m "Release @mcp-decorator/plugin-math@${{ steps.changes.outputs.math_new }}" || true
          fi
          if [ "${{ steps.changes.outputs.filesystem }}" = "true" ]; then
            git tag -a "plugin-filesystem@${{ steps.changes.outputs.filesystem_new }}" -m "Release @mcp-decorator/plugin-filesystem@${{ steps.changes.outputs.filesystem_new }}" || true
          fi
          if [ "${{ steps.changes.outputs.http }}" = "true" ]; then
            git tag -a "plugin-http@${{ steps.changes.outputs.http_new }}" -m "Release @mcp-decorator/plugin-http@${{ steps.changes.outputs.http_new }}" || true
          fi
          if [ "${{ steps.changes.outputs.memory }}" = "true" ]; then
            git tag -a "plugin-memory@${{ steps.changes.outputs.memory_new }}" -m "Release @mcp-decorator/plugin-memory@${{ steps.changes.outputs.memory_new }}" || true
          fi

          git push --tags || true

      - name: ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        if: steps.changes.outputs.any_changed == 'true'
        id: release_notes
        run: |
          NOTES="## ğŸ“¦ æœ¬æ¬¡å‘å¸ƒçš„åŒ…\n\n"

          if [ "${{ steps.changes.outputs.core }}" = "true" ]; then
            NOTES="${NOTES}- [@mcp-decorator/core@${{ steps.changes.outputs.core_new }}](https://www.npmjs.com/package/@mcp-decorator/core)\n"
          fi
          if [ "${{ steps.changes.outputs.math }}" = "true" ]; then
            NOTES="${NOTES}- [@mcp-decorator/plugin-math@${{ steps.changes.outputs.math_new }}](https://www.npmjs.com/package/@mcp-decorator/plugin-math)\n"
          fi
          if [ "${{ steps.changes.outputs.filesystem }}" = "true" ]; then
            NOTES="${NOTES}- [@mcp-decorator/plugin-filesystem@${{ steps.changes.outputs.filesystem_new }}](https://www.npmjs.com/package/@mcp-decorator/plugin-filesystem)\n"
          fi
          if [ "${{ steps.changes.outputs.http }}" = "true" ]; then
            NOTES="${NOTES}- [@mcp-decorator/plugin-http@${{ steps.changes.outputs.http_new }}](https://www.npmjs.com/package/@mcp-decorator/plugin-http)\n"
          fi
          if [ "${{ steps.changes.outputs.memory }}" = "true" ]; then
            NOTES="${NOTES}- [@mcp-decorator/plugin-memory@${{ steps.changes.outputs.memory_new }}](https://www.npmjs.com/package/@mcp-decorator/plugin-memory)\n"
          fi

          # ä½¿ç”¨ EOF å¤„ç†å¤šè¡Œ
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“ åˆ›å»º GitHub Release
        if: steps.changes.outputs.any_changed == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ github.run_number }}
          name: Release ${{ github.run_number }}
          body: |
            ${{ steps.release_notes.outputs.notes }}

            ## ğŸ“š æ–‡æ¡£

            - [å¿«é€Ÿå…¥é—¨](https://github.com/fromsko/mcp-decorator-framework/blob/main/docs/GETTING_STARTED.md)
            - [API å‚è€ƒ](https://github.com/fromsko/mcp-decorator-framework/blob/main/docs/API.md)
            - [æ’ä»¶å¼€å‘](https://github.com/fromsko/mcp-decorator-framework/blob/main/docs/plugin-development.md)
            - [éƒ¨ç½²æŒ‡å—](https://github.com/fromsko/mcp-decorator-framework/blob/main/docs/deployment.md)

            ## ğŸ“ å˜æ›´æ—¥å¿—

            æŸ¥çœ‹ [CHANGELOG.md](https://github.com/fromsko/mcp-decorator-framework/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ã€‚

            ## ğŸš€ å®‰è£…

            ```bash
            npm install @mcp-decorator/core reflect-metadata zod
            ```
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: â­ï¸ è·³è¿‡å‘å¸ƒ
        if: steps.changes.outputs.any_changed == 'false'
        run: echo "æ²¡æœ‰åŒ…ç‰ˆæœ¬å˜åŒ–ï¼Œè·³è¿‡å‘å¸ƒ"
